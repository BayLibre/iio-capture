#!/bin/bash

## ABI:
#
# arg1 : probe number
# arg2 : filename for attached data contents

if [ -f /tmp/pidfile-$1 ]
then
	echo "WARNING iio probe $1 already running";
	cat  /tmp/pidfile-$1 | xargs kill -9
	sleep 2
	sync
	sudo rm -rf /tmp/pidfile-$1
fi

iio-capture --csv --fout $2 -n lab-baylibre-acme.local iio:device$1 > /tmp/stats-$1 &

echo "text/csv" > $2.mimetype

## Trials with Gnuplot (remove the --csv option)
#
#echo set term png > /tmp/gnuplot-$1 
#echo set output \""$2".png\" >> /tmp/gnuplot-$1
#echo "plot \""$2"\" binary format=\"%4int16%int64\" u 5:1 w l title \"vhsunt\", \\" >> /tmp/gnuplot-$1
#echo "\""$2"\" binary format=\"%4int16%int64\" u 5:2 w l title \"vbus\", \\" >> /tmp/gnuplot-$1
#echo "\""$2"\" binary format=\"%4int16%int64\" u 5:4 w l title \"current\", \\" >> /tmp/gnuplot-$1
#echo "\""$2"\" binary format=\"%4int16%int64\" u 5:3 w l title \"power\"" >> /tmp/gnuplot-$1
#echo "image/png" > $2.png.mimetype

echo $! > /tmp/pidfile-$1
